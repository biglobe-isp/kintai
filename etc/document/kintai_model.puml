@startuml

package api {
    class Main {
        'パラメータのValidation
        'ServiceにわたすEntity, ValueObjectの生成
        void main()
    }
}

package service {
    class AttendanceService <<Service>> {
        '遅刻の場合はNG → 勤務時間の算出 → 登録
        void registerAttendance(Attendance attendance)
    }

    class MonthlySummaryService <<Service>> {
        '当月分のAttendance取得 → 集計処理呼び出し
        List<MonthlySummary> acquireMonthlyTotal(YearMonth yearMonth)
    }
}

package datasource {
    class AttendanceRepositoryCsv <<Datasource>> {
        void save(Attendance attendance)
        List<Attendance> findSpecifiedYearMonth(YearMonth workMonth)
    }

    file csv {
    }
}

package domain {

    package Attendance {
        class Attendance <<Entity>>{
            LocaleDate workDay
            --
            StartTime startTime
            EndTime endTime
            WorkingHours workingHours
            OverTimeHours overTimeHours
        }

        class StartTime <<ValueObject>> {
            TimeUnit startTime
            --
            boolean isLateness(WorkRegulations workRegulations)
        }

        class EndTime <<ValueObject>> {
            TimeUnit endTime
            --
            boolean isLeaveEarly(WorkRegulations workRegulations)
        }

        class OverTimeHours <<ValueObject>> {
            TimeUnit overTimeHours
            --
            TimeUnit get(StartTime startTime, EndTime endTime, WorkRegulations workRegulations)
        }

        class WorkingHours <<ValueObject>> {
            TimeUnit workingHours
            BreakTimeHours breakTimeHours
            --
            TimeUnit get(StartTime startTime, EndTime endTime, WorkRegulations workRegulations)
        }

        class BreakTimeHours <<ValueObject>> {
            TimeUnit breakTimeHours
            --
            TimeUnit get(StartTime startTime, EndTime endTime, WorkRegulations workRegulations)
        }
    }

    package WorkRegulations {

        class WorkRegulations <<ValueObject>> {
            StartTime startTime
            EndTime endTime
            BreakTimes breakTimes
        }

        class StartTimeRange <<ValueObject>> {
            LocaleTime standardStartTime
            AllowanceTimeRange startTimeRange
        }

        class EndTimeRange <<ValueObject>> {
            LocaleTime standardEndTime
            AllowanceTimeRange endTimeRange
        }

        class AllowanceTimeRange <<ValueObject>> {
            LocaleTime minTime
            LocaleTime maxTime
        }

        class BreakTimes <<ValueObject>> {
            TimeRange lunchBreakTime
            TimeRange eveningBreakTime
            TimeRange nightBreakTime
        }
    }

    package MonthlySummary {
        class MonthlySummaryCalculator <<DomainService>> {
            List<MonthlySummary> aggregateSpecifiedMonthAttendance(YearMonth yearMonth)
        }

        class MonthlySummary <<ValueObject>> {
            YearMonth workMonth
            int workingHours
            int overTimeHours
        }

        class YearMonth <<ValueObject>> {
            int year
            int month
        }
    }

    class TimeUnit <<ValueObject>> {
        int hour
        int minutes
    }

    class TimeRange <<ValueObject>> {
        TimeUnit timeFrom
        TimeUnit timeTo
        --
        int getRange()
    }

    interface AttendanceRepository <<Repository>> {
        void save(Attendance attendance)
        List<Attendance> findSpecifiedYearMonth(YearMonth workMonth)
    }
}


'***** 相関関係 *****
Main ---> service : registerAttendance or AcquireMonthlyTotal
AttendanceService -[hidden]- MonthlySummaryService

AttendanceService --> AttendanceRepository : save
AttendanceService -> WorkRegulations

MonthlySummaryService --> AttendanceRepository : 1.find
MonthlySummaryService --> MonthlySummaryCalculator : 2.aggregate
MonthlySummaryCalculator --> MonthlySummary

AttendanceRepository ---> Attendance
MonthlySummaryCalculator ---> Attendance

AttendanceRepositoryCsv --> csv

'依存
OverTimeHours ...> WorkRegulations
WorkingHours ...> WorkRegulations
BreakTimeHours ...> WorkRegulations
StartTime ...> WorkRegulations
EndTime ...> WorkRegulations

'実装
AttendanceRepository <|... AttendanceRepositoryCsv

'集約
Attendance *-- StartTime
Attendance *-- EndTime
Attendance *-- WorkingHours
Attendance *-- OverTimeHours

WorkRegulations *-- BreakTimes
WorkRegulations *-- StartTimeRange
WorkRegulations *-- EndTimeRange

'コンポジション(has-a | 強い集約)
WorkingHours o-- BreakTimeHours
StartTimeRange o-- AllowanceTimeRange
EndTimeRange o-- AllowanceTimeRange
MonthlySummary o-- YearMonth

WorkRegulations -[hidden]- TimeUnit
WorkRegulations -[hidden]- TimeRange

@enduml